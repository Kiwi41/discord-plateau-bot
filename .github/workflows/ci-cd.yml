name: ğŸ¤– Discord Bot CI/CD

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    name: ğŸ§ª Test Docker Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ—ï¸ Build test image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: discord-plateau-bot:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ§ª Test container startup
      run: |
        echo "ğŸ” Test de dÃ©marrage du conteneur..."
        timeout 30 docker run --rm \
          -e DISCORD_TOKEN="test_token" \
          -e GUILD_ID="123456789" \
          -e FORUM_CHANNEL_ID="987654321" \
          discord-plateau-bot:test || echo "âœ… Test terminÃ©"

  build:
    name: ğŸ—ï¸ Build & Push Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: ğŸ—ï¸ Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  notify:
    name: ï¿½ Notify Build Success
    runs-on: ubuntu-latest
    needs: build
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¢ Send Discord notification
      if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      with:
        args: |
          ğŸ¤– **Bot Discord Plateau - Build Complete**
          
          **Status**: ${{ needs.build.result == 'success' && 'âœ… Image prÃªte' || 'âŒ Build Ã©chouÃ©' }}
          **Version**: `${{ github.sha }}`
          **Image**: `ghcr.io/${{ github.repository }}:latest`
          **Commit**: [${{ github.event.head_commit.message }}](${{ github.event.head_commit.url }})
          
          ğŸ³ Pour dÃ©ployer sur votre NAS:
          ```bash
          docker pull ghcr.io/${{ github.repository }}:latest
          docker compose up -d
          ```
          
          ğŸ”— [Voir les dÃ©tails](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})