digraph event_processing {
    rankdir=TB;
    bgcolor="white";
    
    // Styling
    node [shape=box, style=filled, fontname="Arial", fontsize=10];
    edge [fontname="Arial", fontsize=9];
    
    // Input
    start [label="📅 Traitement vendredi\n(date spécifique)", 
           shape=ellipse, fillcolor="#4caf50", fontcolor="white"];
    
    // API Call with retry
    subgraph cluster_api {
        label="🌐 Appels API Discord";
        style=filled;
        fillcolor="#e3f2fd";
        
        api_call [label="🔗 guild.scheduledEvents.fetch()\nRécupération événements", fillcolor="#bbdefb"];
        timeout_check [label="⏱️ Timeout check\n(30 secondes)", fillcolor="#bbdefb"];
        retry_logic [label="🔄 Retry logic\n2s → 4s → 6s", fillcolor="#ffcdd2"];
    }
    
    // Event filtering
    subgraph cluster_filter {
        label="🔍 Filtrage événements";
        style=filled;
        fillcolor="#e8f5e8";
        
        filter_date [label="📅 Filtrer par date\n(vendredi cible)", fillcolor="#c8e6c9"];
        filter_keywords [label="🔍 Mots-clés\n['plateau', 'soirée', 'jeu']", fillcolor="#c8e6c9"];
        recurrent_priority [label="🎯 Priorité récurrents\n(EVENT_ID si configuré)", fillcolor="#c8e6c9"];
    }
    
    // Data extraction
    subgraph cluster_extract {
        label="📝 Extraction données";
        style=filled;
        fillcolor="#fff3e0";
        
        extract_time [label="🕒 Heure événement\nstartTimestamp", fillcolor="#ffcc02"];
        extract_location [label="📍 Lieu événement\nentityMetadata.location", fillcolor="#ffcc02"];
        extract_description [label="📄 Description\nevent.description", fillcolor="#ffcc02"];
        format_data [label="🎨 Formatage\n(timezone, liens)", fillcolor="#ffcc02"];
    }
    
    // Forum interaction
    subgraph cluster_forum {
        label="📋 Interaction forum";
        style=filled;
        fillcolor="#f3e5f5";
        
        search_existing [label="🔍 Recherche post existant\npar titre et date", fillcolor="#e1bee7"];
        compare_content [label="🔄 Comparaison\nheure, lieu, description", fillcolor="#e1bee7"];
        create_embed [label="💎 Création embed\nDiscord (couleur, champs)", fillcolor="#e1bee7"];
        forum_action [label="⚡ Action forum\n(créer/mettre à jour)", fillcolor="#e1bee7"];
    }
    
    // Decision points
    events_found [label="Événements\ntrouvés ?", shape=diamond, fillcolor="#ffeb3b"];
    matching_event [label="Événement\ncorrespondant ?", shape=diamond, fillcolor="#ffeb3b"];
    post_exists [label="Post forum\nexiste ?", shape=diamond, fillcolor="#ffeb3b"];
    content_different [label="Contenu\ndifférent ?", shape=diamond, fillcolor="#ffeb3b"];
    
    // Outcomes
    use_event_data [label="✅ Utiliser données\névénement Discord", fillcolor="#4caf50", fontcolor="white"];
    use_defaults [label="⚙️ Utiliser valeurs\npar défaut", fillcolor="#ff9800", fontcolor="white"];
    create_new [label="📝 Créer nouveau\npost forum", fillcolor="#2196f3", fontcolor="white"];
    update_existing [label="🔄 Mettre à jour\npost existant", fillcolor="#9c27b0", fontcolor="white"];
    no_action [label="✅ Aucune action\ndéjà à jour", fillcolor="#607d8b", fontcolor="white"];
    
    // Error states
    api_error [label="❌ Erreur API\n(timeout, permission)", fillcolor="#f44336", fontcolor="white"];
    forum_error [label="❌ Erreur forum\n(permission, limite)", fillcolor="#f44336", fontcolor="white"];
    
    // Logging
    log_success [label="📊 Log succès\n(action, timestamp)", fillcolor="#4caf50", fontcolor="white"];
    log_error [label="📊 Log erreur\n(détails, context)", fillcolor="#f44336", fontcolor="white"];
    
    // Flow
    start -> api_call;
    
    // API flow with retry
    api_call -> timeout_check;
    timeout_check -> events_found [label="✅ Succès"];
    timeout_check -> retry_logic [label="❌ Timeout"];
    retry_logic -> api_call [label="Nouvelle tentative"];
    retry_logic -> api_error [label="3 échecs"];
    
    // Event processing flow
    events_found -> filter_date [label="✅ Oui"];
    events_found -> use_defaults [label="❌ Aucun"];
    
    filter_date -> filter_keywords;
    filter_keywords -> recurrent_priority;
    recurrent_priority -> matching_event;
    
    matching_event -> extract_time [label="✅ Trouvé"];
    matching_event -> use_defaults [label="❌ Aucun"];
    
    // Data extraction flow
    extract_time -> extract_location -> extract_description -> format_data;
    format_data -> use_event_data;
    
    // Forum interaction flow
    use_event_data -> search_existing;
    use_defaults -> search_existing;
    
    search_existing -> post_exists;
    post_exists -> compare_content [label="✅ Existe"];
    post_exists -> create_embed [label="❌ Nouveau"];
    
    compare_content -> content_different;
    content_different -> update_existing [label="✅ Différent"];
    content_different -> no_action [label="❌ Identique"];
    
    create_embed -> forum_action;
    forum_action -> create_new [label="Nouveau post"];
    forum_action -> update_existing [label="Mise à jour"];
    forum_action -> forum_error [label="❌ Erreur"];
    
    // Success logging
    create_new -> log_success;
    update_existing -> log_success;
    no_action -> log_success;
    
    // Error logging
    api_error -> log_error;
    forum_error -> log_error;
    
    // Timeline annotations
    edge [style=dotted, color="gray", fontsize=8];
    api_call -> api_call [label="~2-5 secondes"];
    search_existing -> search_existing [label="~1-2 secondes"];
    create_embed -> create_embed [label="~0.5 seconde"];
}